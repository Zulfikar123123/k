<script>
    const myVideos = [
        { 
            title: "المقطع الجديد الخاص بك", 
            img: "https://via.placeholder.com/150", 
            url: "https://pomf2.lain.la/f/gk6vjy34.mp4" 
        },
        { title: "قصة جديدة", img: "", url: "https://pomf2.lain.la/f/2kmvmtqc.mp4" },
        { title: "فيديو 2", img: "", url: "https://pomf2.lain.la/f/2zv7s4.mp4" },
        { title: "فيديو 3", img: "", url: "https://pomf2.lain.la/f/wq5mewq.mp4" },
        { title: "فيديو 4", img: "", url: "https://pomf2.lain.la/f/4tzdviq0.mp4" }
    ]; // تأكد دائماً من وجود هذا القوس المربع هنا

    let currentVideoUrl = "";
    let startTime = 0;
    let timerStarted = false;
    let popUnderExecuted = false;

    const grid = document.getElementById('video-grid');
    myVideos.forEach(vid => {
        grid.innerHTML += `
            <div class="video-card" onclick="preparePlayer('${vid.url}')">
                <img src="${vid.img || 'https://via.placeholder.com/150'}">
                <div class="video-info">${vid.title}</div>
            </div>`;
    });

    function loadPopUnder() {
        if (!popUnderExecuted) {
            const script = document.createElement('script');
            script.src = "https://twigcrucialpal.com/a8/03/68/a80368812dec3f6d3f22da29616fb388.js";
            document.body.appendChild(script);
            popUnderExecuted = true;
        }
    }

    function preparePlayer(videoUrl) {
        loadPopUnder();
        currentVideoUrl = videoUrl;
        timerStarted = false;
        document.getElementById('player-overlay').style.display = 'block';
        resetUI();
    }

    function resetUI() {
        document.getElementById('waiting-screen').style.display = 'block';
        document.getElementById('video-iframe').style.display = 'none';
        document.getElementById('video-iframe').src = "";
        updateUI("تأكيد المشاهدة", "يجب الضغط على الزر أدناه والبقاء في صفحة الإعلان لمدة 10 ثوانٍ", "شاهد الاعلان لمدة 10 ثواني");
    }

    function openAd() {
        const smartLink = "https://twigcrucialpal.com/kvwft44afa?key=cb80200a80e072a4d94407f211fa613c"; 
        window.open(smartLink, '_blank');
        startTime = new Date().getTime(); 
        timerStarted = true;
        updateUI("جاري التحقق...", "الرجاء البقاء في صفحة الإعلان 10 ثوانٍ لفتح المقطع", "انتظر ثواني...");
    }

    window.onfocus = function() {
        if (timerStarted) {
            let currentTime = new Date().getTime();
            let secondsPassed = Math.floor((currentTime - startTime) / 1000);

            if (secondsPassed >= 10) {
                document.getElementById('waiting-screen').style.display = 'none';
                const ifr = document.getElementById('video-iframe');
                ifr.src = currentVideoUrl;
                ifr.style.display = 'block';
                timerStarted = false;
            } else {
                let remaining = 10 - secondsPassed;
                updateUI("فشل التأكيد!", `لقد عدت مبكراً جداً (متبقي ${remaining} ثانية)`, "إعادة المحاولة والبقاء في الاعلان", true);
            }
        }
    };

    function updateUI(title, msg, btnText, isFail = false) {
        document.getElementById('wait-title').innerText = title;
        document.getElementById('wait-msg').innerText = msg;
        const btn = document.getElementById('trigger-ad-btn');
        btn.innerText = btnText;
        if (isFail) {
            btn.classList.add('btn-fail');
        } else {
            btn.classList.remove('btn-fail');
        }
    }

    function closePlayer() {
        document.getElementById('player-overlay').style.display = 'none';
        document.getElementById('video-iframe').src = "";
        timerStarted = false;
    }
</script>
